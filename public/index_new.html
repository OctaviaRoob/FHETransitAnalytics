<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœºå¯†å…¬äº¤å¡æ•°æ®åˆ†æ - Confidential Transit Analytics</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #7e22ce 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { text-align: center; color: white; padding: 40px 0; margin-bottom: 40px; }
        .header h1 { font-size: 2.5em; margin-bottom: 15px; text-shadow: 2px 2px 8px rgba(0,0,0,0.3); }
        .header p { font-size: 1.2em; opacity: 0.95; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 25px; margin-bottom: 25px; }
        .card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 20px; padding: 35px; box-shadow: 0 15px 35px rgba(0,0,0,0.2); transition: transform 0.3s ease; }
        .card:hover { transform: translateY(-5px); }
        .card h2 { color: #1e3c72; margin-bottom: 25px; font-size: 1.5em; display: flex; align-items: center; gap: 12px; }
        .card h2::before { content: ''; width: 5px; height: 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; }
        .status-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 25px; }
        .status-item { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 15px; text-align: center; color: white; }
        .status-item label { display: block; font-weight: 600; margin-bottom: 10px; font-size: 0.85em; text-transform: uppercase; }
        .status-item .value { font-size: 1.8em; font-weight: 800; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 10px; color: #1e3c72; font-weight: 700; font-size: 0.95em; }
        .form-group input { width: 100%; padding: 15px; border: 2px solid #e0e7ff; border-radius: 12px; font-size: 1.05em; transition: all 0.3s; background: #f8fafc; }
        .form-group input:focus { outline: none; border-color: #667eea; background: white; }
        .btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 18px 35px; border: none; border-radius: 12px; font-size: 1.1em; cursor: pointer; width: 100%; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-top: 10px; }
        .btn:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4); }
        .btn:disabled { background: linear-gradient(135deg, #94a3b8 0%, #cbd5e1 100%); cursor: not-allowed; }
        .btn-secondary { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .btn-success { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
        .alert { padding: 15px; border-radius: 12px; margin-bottom: 20px; font-weight: 600; border-left: 5px solid; }
        .alert-info { background-color: #dbeafe; color: #1e40af; border-left-color: #3b82f6; }
        .alert-success { background-color: #d1fae5; color: #065f46; border-left-color: #10b981; }
        .alert-warning { background-color: #fef3c7; color: #92400e; border-left-color: #f59e0b; }
        .alert-danger { background-color: #fee2e2; color: #991b1b; border-left-color: #ef4444; }
        .hidden { display: none; }
        .wallet-info { background: linear-gradient(135deg, #fef3c7 0%, #fcd34d 100%); padding: 20px; border-radius: 12px; margin-bottom: 20px; font-weight: 600; color: #92400e; }
        .time-info { background: linear-gradient(135deg, #ddd6fe 0%, #c4b5fd 100%); padding: 20px; border-radius: 12px; margin-bottom: 20px; font-weight: 600; color: #5b21b6; }
        .privacy-note { background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); padding: 15px; border-radius: 10px; margin-top: 15px; font-size: 0.9em; color: #065f46; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸšŒ æœºå¯†å…¬äº¤å¡æ•°æ®åˆ†æ</h1>
            <p>Confidential Public Transit Analytics using Commitment Scheme</p>
            <p style="font-size:0.9em; opacity:0.8; margin-top:10px;">éšç§ä¿æŠ¤ â€¢ æ‰¿è¯ºæ–¹æ¡ˆ â€¢ Sepolia Testnet</p>
        </div>

        <!-- Wallet -->
        <div class="card">
            <h2>ğŸ’³ é’±åŒ…è¿æ¥</h2>
            <div id="walletInfo" class="hidden wallet-info">
                <strong>å·²è¿æ¥åœ°å€:</strong> <span id="walletAddress"></span>
            </div>
            <button id="connectBtn" class="btn">è¿æ¥ MetaMask</button>
        </div>

        <div class="grid">
            <!-- Status -->
            <div class="card">
                <h2>ğŸ“Š å½“å‰å‘¨æœŸçŠ¶æ€</h2>
                <div id="timeInfo" class="time-info">
                    <strong>å½“å‰çª—å£:</strong> <span id="currentWindow">æ£€æµ‹ä¸­...</span><br>
                    <strong>å½“å‰å°æ—¶:</strong> <span id="currentHour">--</span>
                </div>
                <div class="status-grid">
                    <div class="status-item"><label>å‘¨æœŸ#</label><div class="value" id="currentPeriod">--</div></div>
                    <div class="status-item"><label>æ•°æ®çŠ¶æ€</label><div class="value" id="dataCollected">--</div></div>
                    <div class="status-item"><label>å‘¨æœŸ</label><div class="value" id="periodClosed">--</div></div>
                    <div class="status-item"><label>å‚ä¸è€…</label><div class="value" id="participantCount">0</div></div>
                </div>
                <button id="refreshBtn" class="btn btn-secondary">åˆ·æ–°çŠ¶æ€</button>
            </div>

            <!-- Initialize -->
            <div class="card">
                <h2>ğŸ¯ åˆå§‹åŒ–å‘¨æœŸ</h2>
                <div id="initAlert" class="alert alert-info">
                    â° åªèƒ½åœ¨å¥‡æ•°å°æ—¶åˆå§‹åŒ– (13:00, 15:00, 17:00...)
                </div>
                <button id="initBtn" class="btn">åˆå§‹åŒ–æ–°å‘¨æœŸ</button>
            </div>
        </div>

        <div class="grid">
            <!-- Submit -->
            <div class="card">
                <h2>ğŸ”’ æäº¤åŠ å¯†æ•°æ®</h2>
                <div id="submitAlert" class="alert alert-info">
                    â° åªèƒ½åœ¨å¥‡æ•°å°æ—¶æäº¤æ•°æ®ï¼ˆæäº¤çª—å£ï¼‰
                </div>
                <div class="form-group">
                    <label for="spendingInput">æ¶ˆè´¹é‡‘é¢ï¼ˆåˆ†ï¼‰</label>
                    <input type="number" id="spendingInput" placeholder="ä¾‹å¦‚: 500 (= Â¥5.00)" min="0" max="100000">
                </div>
                <div class="form-group">
                    <label for="ridesInput">ä¹˜è½¦æ¬¡æ•°</label>
                    <input type="number" id="ridesInput" placeholder="ä¾‹å¦‚: 10" min="0" max="255">
                </div>
                <button id="submitBtn" class="btn">æäº¤æ•°æ®æ‰¿è¯º</button>
                <div class="privacy-note">
                    ğŸ” <strong>éšç§ä¿æŠ¤:</strong> æ‚¨çš„æ•°æ®ä¼šè¢«è½¬æ¢ä¸ºå“ˆå¸Œæ‰¿è¯ºã€‚åŸå§‹æ•°æ®ä¸ä¼šæš´éœ²åœ¨é“¾ä¸Šã€‚
                </div>
            </div>

            <!-- Analysis -->
            <div class="card">
                <h2>ğŸ” æ‰§è¡Œåˆ†æ</h2>
                <div id="analysisAlert" class="alert alert-info">
                    â° åªèƒ½åœ¨å¶æ•°å°æ—¶åˆ†æ (14:00, 16:00, 18:00...)
                </div>
                <button id="revealBtn" class="btn btn-success">1. æ­ç¤ºæˆ‘çš„æ•°æ®</button>
                <button id="analysisBtn" class="btn btn-success">2. æ‰§è¡Œèšåˆåˆ†æ</button>
                <div class="privacy-note" style="background: linear-gradient(135deg, #ddd6fe 0%, #c4b5fd 100%); color: #5b21b6;">
                    ğŸ“Š <strong>èšåˆè¾“å‡º:</strong> åˆ†æåªä¼šå…¬å¼€æ€»è®¡å’Œå¹³å‡å€¼ï¼Œä¸ä¼šå…¬å¼€ä¸ªäººæ•°æ®ã€‚
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script>
        const CONTRACT_ADDRESS = "YOUR_CONTRACT_ADDRESS"; // éƒ¨ç½²åæ›´æ–°
        const EXPECTED_CHAIN_ID = 11155111; // Sepolia
        const CONTRACT_ABI = [
            "function initializePeriod() external",
            "function submitCardData(bytes32 _commitment) external",
            "function revealCardData(uint32 _spending, uint8 _rides, bytes32 _salt) external",
            "function performAnalysis() external",
            "function getCurrentPeriodInfo() external view returns (uint32, bool, bool, uint256, uint256)",
            "function getCardDataStatus(address) external view returns (bool, uint256)",
            "function getCurrentAdjustedHour() external view returns (uint256)",
            "function isOddHourWindow() public view returns (bool)",
            "function isEvenHourWindow() public view returns (bool)",
            "function isSubmissionActive() public view returns (bool)",
            "function isAnalysisActive() public view returns (bool)",
            "function generateCommitment(uint32, uint8, bytes32) public pure returns (bytes32)"
        ];

        let provider, signer, contract, userAddress;
        let currentData = { spending: 0, rides: 0, salt: null }; // Store for reveal phase

        // Connect wallet
        document.getElementById('connectBtn').addEventListener('click', async () => {
            try {
                if (typeof window.ethereum === 'undefined') {
                    alert('è¯·å®‰è£… MetaMask!');
                    return;
                }

                if (CONTRACT_ADDRESS === "YOUR_CONTRACT_ADDRESS") {
                    showAlert('warning', 'åˆçº¦æœªéƒ¨ç½²ï¼è¯·å…ˆéƒ¨ç½²åˆçº¦å¹¶æ›´æ–°åœ°å€ã€‚');
                    return;
                }

                await window.ethereum.request({ method: 'eth_requestAccounts' });
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                userAddress = await signer.getAddress();

                const network = await provider.getNetwork();
                if (network.chainId !== EXPECTED_CHAIN_ID) {
                    showAlert('danger', `é”™è¯¯çš„ç½‘ç»œï¼è¯·åˆ‡æ¢åˆ° Sepolia (chainId: ${EXPECTED_CHAIN_ID})`);
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: '0x' + EXPECTED_CHAIN_ID.toString(16) }],
                        });
                        location.reload();
                    } catch (e) {}
                    return;
                }

                document.getElementById('walletAddress').textContent =
                    userAddress.substring(0, 6) + '...' + userAddress.substring(38);
                document.getElementById('walletInfo').classList.remove('hidden');
                document.getElementById('connectBtn').textContent = 'âœ“ å·²è¿æ¥';
                document.getElementById('connectBtn').disabled = true;

                contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                await loadStatus();
                showAlert('success', 'é’±åŒ…è¿æ¥æˆåŠŸï¼');
            } catch (error) {
                console.error(error);
                showAlert('danger', 'è¿æ¥å¤±è´¥: ' + error.message);
            }
        });

        // Load status
        async function loadStatus() {
            if (!contract) return;
            try {
                const info = await contract.getCurrentPeriodInfo();
                const currentHour = await contract.getCurrentAdjustedHour();
                const isOdd = await contract.isOddHourWindow();
                const isEven = await contract.isEvenHourWindow();
                const canSubmit = await contract.isSubmissionActive();
                const canAnalyze = await contract.isAnalysisActive();

                document.getElementById('currentPeriod').textContent = info[0].toString();
                document.getElementById('dataCollected').textContent = info[1] ? 'âœ“ æ´»è·ƒ' : 'âœ— æœªæ¿€æ´»';
                document.getElementById('periodClosed').textContent = info[2] ? 'å·²å…³é—­' : 'å¼€æ”¾';
                document.getElementById('participantCount').textContent = info[4].toString();
                document.getElementById('currentHour').textContent = currentHour.toString();

                let windowText = '';
                if (isOdd) windowText = 'ğŸŸ¢ å¥‡æ•°å°æ—¶ - æäº¤çª—å£';
                else if (isEven) windowText = 'ğŸ”µ å¶æ•°å°æ—¶ - åˆ†æçª—å£';
                document.getElementById('currentWindow').textContent = windowText;

                document.getElementById('initBtn').disabled = !isOdd || (info[1] && !info[2]);
                document.getElementById('submitBtn').disabled = !canSubmit;
                document.getElementById('revealBtn').disabled = !canAnalyze;
                document.getElementById('analysisBtn').disabled = !canAnalyze;
            } catch (error) {
                console.error('åŠ è½½çŠ¶æ€å¤±è´¥:', error);
            }
        }

        // Initialize period
        document.getElementById('initBtn').addEventListener('click', async () => {
            if (!contract) return showAlert('warning', 'è¯·å…ˆè¿æ¥é’±åŒ…ï¼');
            try {
                showAlert('info', 'æ­£åœ¨åˆå§‹åŒ–æ–°å‘¨æœŸ...');
                const tx = await contract.initializePeriod();
                await tx.wait();
                showAlert('success', 'å‘¨æœŸåˆå§‹åŒ–æˆåŠŸï¼');
                await loadStatus();
            } catch (error) {
                console.error(error);
                showAlert('danger', 'åˆå§‹åŒ–å¤±è´¥: ' + (error.reason || error.message));
            }
        });

        // Submit data (commitment)
        document.getElementById('submitBtn').addEventListener('click', async () => {
            if (!contract) return showAlert('warning', 'è¯·å…ˆè¿æ¥é’±åŒ…ï¼');

            const spending = parseInt(document.getElementById('spendingInput').value);
            const rides = parseInt(document.getElementById('ridesInput').value);

            if (!spending || !rides) return showAlert('warning', 'è¯·å¡«å†™æ‰€æœ‰å­—æ®µï¼');

            try {
                // Generate random salt
                const salt = ethers.utils.hexlify(ethers.utils.randomBytes(32));

                // Calculate commitment
                const commitment = await contract.generateCommitment(spending, rides, salt);

                // Store for reveal phase
                currentData = { spending, rides, salt };
                localStorage.setItem('transitData_' + userAddress, JSON.stringify(currentData));

                showAlert('info', 'æ­£åœ¨æäº¤æ•°æ®æ‰¿è¯º...');
                const tx = await contract.submitCardData(commitment);
                await tx.wait();
                showAlert('success', 'æ•°æ®æ‰¿è¯ºæäº¤æˆåŠŸï¼æ•°æ®å·²åŠ å¯†ä¿æŠ¤ã€‚è¯·åœ¨å¶æ•°å°æ—¶æ­ç¤ºæ•°æ®ã€‚');
                await loadStatus();

                document.getElementById('spendingInput').value = '';
                document.getElementById('ridesInput').value = '';
            } catch (error) {
                console.error(error);
                showAlert('danger', 'æäº¤å¤±è´¥: ' + (error.reason || error.message));
            }
        });

        // Reveal data
        document.getElementById('revealBtn').addEventListener('click', async () => {
            if (!contract) return showAlert('warning', 'è¯·å…ˆè¿æ¥é’±åŒ…ï¼');

            try {
                // Retrieve stored data
                const stored = localStorage.getItem('transitData_' + userAddress);
                if (!stored) return showAlert('warning', 'æœªæ‰¾åˆ°å¾…æ­ç¤ºçš„æ•°æ®ï¼è¯·ç¡®ä¿æ‚¨åœ¨æäº¤çª—å£æäº¤è¿‡æ•°æ®ã€‚');

                const data = JSON.parse(stored);

                showAlert('info', 'æ­£åœ¨æ­ç¤ºæ•°æ®...');
                const tx = await contract.revealCardData(data.spending, data.rides, data.salt);
                await tx.wait();
                showAlert('success', 'æ•°æ®æ­ç¤ºæˆåŠŸï¼ç°åœ¨å¯ä»¥æ‰§è¡Œèšåˆåˆ†æäº†ã€‚');

                // Clear stored data
                localStorage.removeItem('transitData_' + userAddress);
            } catch (error) {
                console.error(error);
                showAlert('danger', 'æ­ç¤ºå¤±è´¥: ' + (error.reason || error.message));
            }
        });

        // Perform analysis
        document.getElementById('analysisBtn').addEventListener('click', async () => {
            if (!contract) return showAlert('warning', 'è¯·å…ˆè¿æ¥é’±åŒ…ï¼');

            try {
                showAlert('info', 'æ­£åœ¨æ‰§è¡Œèšåˆåˆ†æ...');
                const tx = await contract.performAnalysis();
                await tx.wait();
                showAlert('success', 'åˆ†æå®Œæˆï¼èšåˆç»“æœå·²å‘å¸ƒã€‚');
                await loadStatus();
            } catch (error) {
                console.error(error);
                showAlert('danger', 'åˆ†æå¤±è´¥: ' + (error.reason || error.message));
            }
        });

        // Refresh status
        document.getElementById('refreshBtn').addEventListener('click', loadStatus);

        // Show alert
        function showAlert(type, message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            alertDiv.style.position = 'fixed';
            alertDiv.style.top = '20px';
            alertDiv.style.right = '20px';
            alertDiv.style.zIndex = '9999';
            alertDiv.style.maxWidth = '400px';
            alertDiv.style.boxShadow = '0 10px 25px rgba(0,0,0,0.2)';
            document.body.appendChild(alertDiv);
            setTimeout(() => alertDiv.remove(), 5000);
        }

        // Auto refresh
        setInterval(() => { if (contract) loadStatus(); }, 30000);
    </script>
</body>
</html>